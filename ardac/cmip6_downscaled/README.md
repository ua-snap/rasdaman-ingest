# CMIP6 downscaled data formatting & ingest scripts

This README contains information on the handful of post-processing scripts needed to format bias-adjusted Zarr outputs produced by the CMIP6 downscale pipeline into files ready to ingest into Rasdaman. **Unless otherwise stated, these scripts are intended to run on Chinook, not Zeus, because they deal with massive datasets and could put unnecessary strain on Zeus.**

## zarr_to_netcdf.py

This script converts the final bias-adjusted outputs from Zarr stores to NetCDF files. It also:

- fills any pockets of missing days with NaN
- converts CESM2 model outputs to use 12:00 as the time instead of 00:00

Run this script on Chinook like so:

```
srun --partition=analysis --cpus-per-task=24 --pty /bin/bash # if not already on analysis node
export ADJUSTED_DIR=/beegfs/CMIP6/crstephenson/downscaled/adjusted
export NETCDF_DIR=/beegfs/CMIP6/path/to/netcdfs
conda activate cmip6-utils
python zarr_to_netcdf.py
```

## model_avg_netcdfs.py

This script uses the NetCDF files generated by the `zarr_to_netcdf.py` script to generate an ensemble mean consisting of the subset of models that have all variables and scenarios available.

Run this script on Chinook like so:

```
srun --partition=analysis --cpus-per-task=24 --pty /bin/bash # if not already on analysis node
export NETCDF_DIR=/beegfs/CMIP6/path/to/netcdfs
export MEAN_DIR=/beegfs/CMIP6/path/to/mean_netcdf
conda activate cmip6-utils
python model_avg_netcdfs.py
```

Then, copy the NetCDF files written to `MEAN_DIR` into the `NETCDF_DIR` directory with all of the other NetCDF files. The `wms_netcdfs.py` instructions in the next section assume you have done so.

```
mv $MEAN_DIR/* $NETCDF_DIR/
```

## wms_netcdfs.py

This script generates time-slice aggregate NetCDF files for use as highly-performant WMS coverages. Time slice specifications are currently hard-coded in the script itself.

Run this script on Chinook like so:

```
srun --partition=analysis --cpus-per-task=24 --pty /bin/bash # if not already on analysis node
export NETCDF_DIR=/beegfs/CMIP6/path/to/netcdfs
export WMS_DIR=/beegfs/CMIP6/path/to/wms_netcdfs
conda activate cmip6-utils
python wms_netcdfs.py
```

## generate_wcs_ingest_scripts.py

It's safe to run this script directly on Zeus. It generates a WCS-optimized Rasdaman ingest script for every combination of model/scenario/variable so that each coverage is around 15gb - 26gb and highly performant.

Run the script like so:

```
python generate_wcs_ingest_scripts.py
```
